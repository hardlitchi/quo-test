# 開発ワークフロー

## 概要
quo-testプロジェクトの効率的な開発を行うための推奨ワークフローと手順を定義する。
jOOQとFlywayを使用したデータベース駆動開発における最適な開発サイクルを提供する。

## 基本開発サイクル

### 1. 開発環境の起動手順
開発を開始する際の推奨手順

```bash
# 1. PostgreSQLコンテナを起動
docker compose up -d

# 2. データベース接続確認
docker compose ps

# 3. Flywayマイグレーション実行（必要に応じて）
./gradlew flywayMigrate

# 4. jOOQクラス生成（マイグレーション後は必須）
./gradlew generateJooq

# 5. アプリケーション起動
./gradlew bootRun
```

**重要**: マイグレーションファイルを追加・変更した場合は、必ず`flywayMigrate` → `generateJooq`の順で実行する

### 2. データベーススキーマ変更のワークフロー

#### 新しいテーブル・カラム追加の場合
```bash
# 1. Flywayマイグレーションファイル作成
# src/main/resources/db/migration/V{N}__Description.sql

# 2. マイグレーション実行
./gradlew flywayMigrate

# 3. jOOQクラス再生成（必須）
./gradlew generateJooq

# 4. エンティティクラス更新
# 対応するEntityクラスを修正

# 5. リポジトリクラス更新
# 新しいフィールドに対応するメソッドを追加

# 6. テスト実行（変更検証）
./gradlew test
```

#### 既存テーブル変更の場合
```bash
# 1. 新しいマイグレーションファイル作成
# ALTER文を使用してスキーマを変更

# 2. マイグレーション実行
./gradlew flywayMigrate

# 3. jOOQクラス再生成
./gradlew generateJooq

# 4. 影響を受けるコードを更新
# Entity, Repository, Service, Controller

# 5. テスト更新・実行
./gradlew test
```

## 機能開発のワークフロー

### 推奨開発順序
1. **データベース設計** → Flywayマイグレーション
2. **エンティティ作成・更新** → ドメインモデル
3. **リポジトリ層実装** → データアクセス
4. **サービス層実装** → ビジネスロジック
5. **コントローラー層実装** → API エンドポイント
6. **テスト作成・実行** → 品質保証

### 実装手順の詳細

#### Step 1: データベース層
```bash
# マイグレーションファイル作成
touch src/main/resources/db/migration/V{N}__Add_new_feature.sql

# テーブル作成・変更
./gradlew flywayMigrate

# jOOQクラス生成
./gradlew generateJooq
```

#### Step 2: エンティティ層
```bash
# エンティティクラス作成・更新
# src/main/kotlin/test/quo/hardlitchi/common/entity/

# バリデーションロジック実装
# init block内での制約チェック
```

#### Step 3: リポジトリ層
```bash
# リポジトリクラス作成・更新
# src/main/kotlin/test/quo/hardlitchi/common/repository/

# jOOQを使用したCRUD操作実装
# DSLContextを活用したクエリ作成
```

#### Step 4: サービス層
```bash
# サービスクラス作成・更新
# src/main/kotlin/test/quo/hardlitchi/common/service/

# ビジネスロジックとトランザクション管理
# @Transactionalアノテーション活用
```

#### Step 5: Web層
```bash
# Beanクラス作成（リクエスト・レスポンス）
# src/main/kotlin/test/quo/hardlitchi/web/bean/

# コントローラークラス作成・更新
# src/main/kotlin/test/quo/hardlitchi/web/controller/
```

#### Step 6: テスト実装
```bash
# テストクラス作成
# src/test/kotlin/test/quo/hardlitchi/

# TestContainersを使用したテスト実行
./gradlew test
```

## コード品質管理

### 開発中の継続的チェック
```bash
# ビルドとテストの実行
./gradlew build

# 特定のテストクラス実行
./gradlew test --tests "BookRepositoryTest"

# アプリケーション起動での動作確認
./gradlew bootRun
```

### コード規約
- **Kotlinコーディング規約**に従う
- **日本語コメント**を使用する
- **名前は意味を明確に表現**する
- **NULLセーフティ**を意識する

## デバッグ・トラブルシューティング

### よくある問題と対応

#### jOOQクラスが見つからないエラー
```bash
# 原因: マイグレーション後にjOOQクラス生成を忘れた
# 対応: jOOQクラスを再生成
./gradlew generateJooq
```

#### データベース接続エラー
```bash
# 原因: PostgreSQLコンテナが起動していない
# 対応: コンテナを起動
docker compose up -d

# コンテナ状態確認
docker compose ps

# ログ確認
docker compose logs postgres
```

#### マイグレーションエラー
```bash
# マイグレーション状態確認
./gradlew flywayInfo

# 問題がある場合はクリーンアップ（開発環境のみ）
./gradlew flywayClean
./gradlew flywayMigrate
```

#### テスト失敗時の対応
```bash
# 特定のテストクラス実行（詳細表示）
./gradlew test --tests "ClassName" --info

# テストレポート確認
# build/reports/tests/test/index.html
```

## 効率的な開発のためのTips

### IDEの活用
- **IntelliJ IDEA**の使用を推奨
- **jOOQ**プラグインでクエリ補完を活用
- **Kotlin**プラグインで型安全性を活用

### ホットリロード
```bash
# Spring Boot DevToolsを利用（推奨）
# build.gradle.ktsに以下を追加することを検討
# developmentOnly("org.springframework.boot:spring-boot-devtools")
```

### データベース管理
```bash
# 開発データをリセットしたい場合
docker compose down -v  # ボリューム削除
docker compose up -d    # 再起動
./gradlew flywayMigrate # マイグレーション再実行
```

### パフォーマンス最適化
```bash
# Gradleビルドキャッシュを活用
./gradlew build --build-cache

# 並列実行を有効化（gradle.properties）
org.gradle.parallel=true
org.gradle.configureondemand=true
```

## Git ワークフロー

### ブランチ戦略
- **main**: プロダクション向けコード
- **feature/機能名**: 機能開発用ブランチ
- **fix/修正内容**: バグ修正用ブランチ

### 推奨コミット手順
```bash
# 変更をステージング
git add .

# 日本語でコミットメッセージ
git commit -m "機能追加: 書籍検索機能を実装"

# プッシュ
git push origin feature/book-search
```

## 継続的改善

### 定期的なメンテナンス
- **依存関係の更新**: 定期的にGradleの依存関係を更新
- **テストカバレッジ**: 新機能追加時はテストも追加
- **パフォーマンス**: 定期的にクエリパフォーマンスを確認

### ドキュメント更新
- **API変更時**: 設計書の更新
- **新機能追加時**: READMEや手順書の更新
- **ビルド変更時**: 環境構築手順の見直し