# 例外処理設計書

## 概要
quo-testプロジェクトにおける例外処理の設計を定義する。
Spring Bootの例外処理機能を活用し、一貫性のあるエラーレスポンスを提供する。

## 例外クラス階層

### ルート例外クラス
```kotlin
/**
 * アプリケーション固有の例外のベースクラス
 */
abstract class QuoTestException(
    message: String,
    cause: Throwable? = null
) : RuntimeException(message, cause)
```

### ビジネス例外クラス
```kotlin
/**
 * ビジネスロジック違反例外
 */
class BusinessRuleViolationException(
    message: String,
    cause: Throwable? = null
) : QuoTestException(message, cause)

/**
 * リソース未発見例外
 */
class ResourceNotFoundException(
    resourceType: String,
    identifier: String,
    cause: Throwable? = null
) : QuoTestException("${resourceType}が見つかりません: ${identifier}", cause)

/**
 * 重複リソース例外
 */
class DuplicateResourceException(
    resourceType: String,
    identifier: String,
    cause: Throwable? = null
) : QuoTestException("${resourceType}は既に存在します: ${identifier}", cause)

/**
 * 不正な状態変更例外
 */
class InvalidStateTransitionException(
    message: String,
    cause: Throwable? = null
) : QuoTestException(message, cause)
```

## エラーレスポンス形式

### 共通エラーレスポンス
```kotlin
/**
 * API共通エラーレスポンス
 */
data class ErrorResponse(
    val success: Boolean = false,
    val data: Any? = null,
    val message: String,
    val errors: List<FieldError> = emptyList(),
    val timestamp: String = LocalDateTime.now().toString(),
    val path: String? = null
)

/**
 * フィールドエラー詳細
 */
data class FieldError(
    val field: String,
    val message: String,
    val rejectedValue: Any? = null
)
```

### 成功レスポンス
```kotlin
/**
 * API共通成功レスポンス
 */
data class SuccessResponse<T>(
    val success: Boolean = true,
    val data: T,
    val message: String? = null,
    val timestamp: String = LocalDateTime.now().toString()
)
```

## グローバル例外ハンドラー

### 例外ハンドラー仕様
```kotlin
@RestControllerAdvice
class GlobalExceptionHandler {

    /**
     * リソース未発見例外
     * HTTP 404 NOT FOUND
     */
    @ExceptionHandler(ResourceNotFoundException::class)
    fun handleResourceNotFound(ex: ResourceNotFoundException): ResponseEntity<ErrorResponse>

    /**
     * 重複リソース例外
     * HTTP 409 CONFLICT
     */
    @ExceptionHandler(DuplicateResourceException::class)
    fun handleDuplicateResource(ex: DuplicateResourceException): ResponseEntity<ErrorResponse>

    /**
     * ビジネスルール違反例外
     * HTTP 409 CONFLICT
     */
    @ExceptionHandler(BusinessRuleViolationException::class)
    fun handleBusinessRuleViolation(ex: BusinessRuleViolationException): ResponseEntity<ErrorResponse>

    /**
     * 不正な状態変更例外
     * HTTP 409 CONFLICT
     */
    @ExceptionHandler(InvalidStateTransitionException::class)
    fun handleInvalidStateTransition(ex: InvalidStateTransitionException): ResponseEntity<ErrorResponse>

    /**
     * バリデーションエラー
     * HTTP 400 BAD REQUEST
     */
    @ExceptionHandler(MethodArgumentNotValidException::class)
    fun handleValidationError(ex: MethodArgumentNotValidException): ResponseEntity<ErrorResponse>

    /**
     * 制約違反エラー
     * HTTP 400 BAD REQUEST
     */
    @ExceptionHandler(ConstraintViolationException::class)
    fun handleConstraintViolation(ex: ConstraintViolationException): ResponseEntity<ErrorResponse>

    /**
     * 不正なリクエストデータ
     * HTTP 400 BAD REQUEST
     */
    @ExceptionHandler(HttpMessageNotReadableException::class)
    fun handleInvalidRequestData(ex: HttpMessageNotReadableException): ResponseEntity<ErrorResponse>

    /**
     * その他の例外
     * HTTP 500 INTERNAL SERVER ERROR
     */
    @ExceptionHandler(Exception::class)
    fun handleGenericException(ex: Exception): ResponseEntity<ErrorResponse>
}
```

## 具体的な例外使用例

### 著者関連例外
```kotlin
// 著者が見つからない場合
throw ResourceNotFoundException("著者", "夏目漱石")

// 同名の著者が既に存在する場合
throw DuplicateResourceException("著者", "夏目漱石")
```

### 書籍関連例外
```kotlin
// 書籍が見つからない場合
throw ResourceNotFoundException("書籍", "こころ")

// 同タイトルの書籍が既に存在する場合
throw DuplicateResourceException("書籍", "こころ")

// 出版済み書籍を未出版に戻そうとした場合
throw InvalidStateTransitionException("出版済みの書籍を未出版状態に戻すことはできません: こころ")

// 書籍に著者が設定されていない場合
throw BusinessRuleViolationException("書籍には最低1人の著者が必要です")

// 存在しない著者が指定された場合
throw ResourceNotFoundException("著者", "存在しない著者名")
```

## HTTPステータスコードマッピング

| 例外クラス | HTTPステータス | 説明 |
|-----------|----------------|------|
| ResourceNotFoundException | 404 NOT FOUND | リソースが見つからない |
| DuplicateResourceException | 409 CONFLICT | 重複リソース |
| BusinessRuleViolationException | 409 CONFLICT | ビジネスルール違反 |
| InvalidStateTransitionException | 409 CONFLICT | 不正な状態変更 |
| MethodArgumentNotValidException | 400 BAD REQUEST | バリデーションエラー |
| ConstraintViolationException | 400 BAD REQUEST | 制約違反 |
| HttpMessageNotReadableException | 400 BAD REQUEST | 不正なリクエストデータ |
| Exception（その他） | 500 INTERNAL SERVER ERROR | 予期しないエラー |

## ログ戦略

### エラーログレベル
- **ERROR**: 500系エラー（予期しないエラー）
- **WARN**: 400系エラー（クライアントエラー）
- **INFO**: 正常系の重要な処理

### ログ出力内容
```kotlin
// ERRORレベル
logger.error("予期しないエラーが発生しました", ex)

// WARNレベル
logger.warn("バリデーションエラー: ${ex.message}")
logger.warn("リソース未発見: ${ex.message}")
logger.warn("ビジネスルール違反: ${ex.message}")
```

## 運用考慮事項

### エラーレスポンスの国際化
現在は日本語のみ対応だが、将来的にはメッセージの国際化を検討する。

### スタックトレースの取り扱い
- 開発環境: スタックトレースを含める
- 本番環境: スタックトレースは含めない（セキュリティ考慮）

### エラー監視
- 500系エラーはアラート対象
- 400系エラーの頻度監視（攻撃検知）

## 例外処理のベストプラクティス

### Do（推奨）
- 具体的で分かりやすいエラーメッセージ
- 適切なHTTPステータスコード
- 一貫したエラーレスポンス形式
- ログ出力による問題の追跡可能性

### Don't（非推奨）
- 内部実装の詳細をエラーメッセージに含める
- 機密情報をエラーメッセージに含める
- 同じエラーに対して異なるHTTPステータスコードを返す
- 例外をキャッチして無視する

## テスト戦略

### 例外処理のテスト
- 各例外クラスのテスト
- グローバル例外ハンドラーのテスト
- 各APIエンドポイントでの例外ケースのテスト

### テストケース例
```kotlin
@Test
fun `存在しない著者を検索した場合404エラーが返される`() {
    // テスト実装
}

@Test
fun `重複する著者を登録した場合409エラーが返される`() {
    // テスト実装
}

@Test
fun `バリデーションエラーが発生した場合400エラーが返される`() {
    // テスト実装
}
```