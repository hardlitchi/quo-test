# テスト設計書

## 概要
quo-testプロジェクトのテスト方針と設計について定義する。
TestContainersを使用したリアルなデータベース環境でのテストを実施し、各レイヤーの責務に応じたテスト戦略を採用する。

## テスト方針

### 基本方針
- **テスト駆動開発(TDD)**を推奨し、実装前にテストを作成する
- **TestContainers**を使用してPostgreSQLの実際の環境でテストを実行する
- **各レイヤーの責務**に応じて適切なテストスコープを設定する
- **ビジネスルール**の検証を重点的に行う
- **日本語**でテストケース名とアサーションメッセージを記述する

### テスト環境
- **データベース**: PostgreSQL (TestContainers)
- **テストフレームワーク**: JUnit 5
- **アサーションライブラリ**: AssertJ (Spring Boot Test標準)
- **モックライブラリ**: Mockito (必要に応じて)

## テスト戦略

### 1. エンティティレイヤーテスト
**対象**: `test.quo.hardlitchi.common.entity`

#### テスト内容
- **バリデーションテスト**
  - 必須項目のチェック
  - 値の範囲チェック（価格≥0、生年月日＜現在日付）
  - 文字列の空白チェック
- **ビジネスルールテスト**
  - 出版状況変更可否のロジック（`Book.canChangeStatusTo`）
  - エンティティ初期化時の制約チェック

#### テストクラス例
```kotlin
// BookTest.kt
class BookTest {
    @Test
    fun `書籍作成時に価格が負の値の場合は例外が発生する`()
    
    @Test
    fun `出版済み書籍を未出版に変更できない`()
    
    @Test
    fun `未出版書籍を出版済みに変更できる`()
}
```

### 2. リポジトリレイヤーテスト
**対象**: `test.quo.hardlitchi.common.repository`

#### テスト方針
- **@DataJooqTest**アノテーションを使用してjOOQのテスト環境を構築
- **TestContainers**でPostgreSQLコンテナを起動
- **実際のDB操作**を検証（モックは使用しない）
- **データの整合性**を検証

#### テスト内容

##### BookRepositoryテスト
- **CRUD操作**
  - `insert`: 正常登録、重複登録エラー
  - `update`: 正常更新、存在しない書籍更新エラー、出版状況変更制限
  - `findByTitle`: 存在する/しない書籍の検索
  - `findAll`: 全書籍取得（空リスト含む）
  - `deleteByTitle`: 削除操作、存在しない書籍削除
- **検索機能**
  - `findByPublicationStatus`: 出版状況による絞り込み
  - `existsByTitle`: 存在チェック
- **ビジネスルール検証**
  - 出版済み→未出版への変更時の例外発生
  - 価格の非負制約

##### AuthorRepositoryテスト
- **CRUD操作**: insert, update, findByName, findAll, deleteByName
- **バリデーション**: 生年月日制約（過去日付のみ）
- **参照整合性**: 著者削除時の出版テーブルへの影響

##### PublicationRepositoryテスト
- **CRUD操作**: insert, update, delete, find操作
- **複合主キー**: 書籍タイトル+著者名の組み合わせ
- **参照整合性**: 外部キー制約の検証
- **ビジネスルール**: 書籍の最低1人著者制約

#### テストクラス例
```kotlin
@DataJooqTest
@Testcontainers
class BookRepositoryTest {
    
    @Container
    companion object {
        @JvmStatic
        val postgres = PostgreSQLContainer("postgres:15")
            .withDatabaseName("quo_test")
            .withUsername("quo_user")
            .withPassword("quo_pass")
    }
    
    @Test
    fun `書籍を正常に登録できる`()
    
    @Test
    fun `存在しない書籍を更新しようとすると例外が発生する`()
    
    @Test
    fun `出版済み書籍を未出版に戻そうとすると例外が発生する`()
}
```

### 3. サービスレイヤーテスト
**対象**: `test.quo.hardlitchi.common.service`

#### テスト方針
- **@SpringBootTest**を使用してサービス全体のテスト
- **TestContainers**でデータベース環境を構築
- **ビジネスロジック**の検証を重点的に実施
- **トランザクション**の動作確認

#### テスト内容
- **ビジネスルール検証**
  - 書籍登録時の著者存在チェック
  - 出版状況変更の制御
  - データ整合性の保証
- **例外処理**
  - 不正データに対する適切な例外発生
  - エラーメッセージの妥当性
- **トランザクション**
  - 複数テーブル更新時のロールバック
  - データ一貫性の保証

### 4. コントローラーレイヤーテスト
**対象**: `test.quo.hardlitchi.web.controller`

#### テスト方針
- **@WebMvcTest**を使用してWeb層のみをテスト
- **MockMvc**を使用してHTTPリクエスト/レスポンスを検証
- **サービス層はモック化**して単体テストとして実施

#### テスト内容
- **HTTPステータスコード**の検証
- **リクエスト/レスポンス**の形式検証
- **バリデーション**エラーの適切な処理
- **例外ハンドリング**の動作確認

### 5. 統合テスト
**対象**: アプリケーション全体

#### テスト方針
- **@SpringBootTest**でアプリケーション全体を起動
- **TestContainers**で実際のデータベース環境を使用
- **エンドツーエンド**でAPIの動作を検証

#### テスト内容
- **API呼び出し**の一連の流れ
- **データベース状態**の検証
- **エラーケース**の統合的な検証

## テストデータ管理

### テストデータ戦略
- **@Transactional + @Rollback**による自動ロールバック
- **@DirtiesContext**による適切なコンテキスト管理
- **ファクトリーメソッド**によるテストデータ生成

### サンプルデータ
```kotlin
object TestDataFactory {
    fun createAuthor(
        name: String = "テスト著者",
        birthDate: LocalDate = LocalDate.of(1980, 1, 1)
    ): Author
    
    fun createBook(
        title: String = "テスト書籍",
        price: BigDecimal = BigDecimal("1000"),
        status: PublicationStatus = PublicationStatus.UNPUBLISHED
    ): Book
}
```

## テスト実行環境

### ローカル環境
```bash
# 全テスト実行
./gradlew test

# 特定のテストクラス実行
./gradlew test --tests "BookRepositoryTest"

# 特定のテストメソッド実行
./gradlew test --tests "BookRepositoryTest.書籍を正常に登録できる"

# テストレポート生成
./gradlew test jacocoTestReport
```

### CI/CD環境
- **GitHub Actions**等でのテスト自動実行
- **TestContainers**によるポータブルなテスト環境
- **テストカバレッジ**の測定と品質ゲート

## テストガイドライン

### 命名規則
- **テストクラス名**: `{対象クラス名}Test`
- **テストメソッド名**: 英語で記述する。ただし、@DisplayName で日本語でテストの内容を明確に表現できるようにする。
- **例**: `書籍を正常に登録できる()`, `存在しない著者を削除しようとすると例外が発生する()`

### アサーション
- **AssertThat**を使用した読みやすいアサーション
- **日本語メッセージ**による分かりやすいエラー表示
- **複数の検証項目**がある場合はSoftAssertionsを活用

### テストの品質
- **1テスト1検証**の原則を守る
- **テストの独立性**を保証する
- **読みやすく保守しやすい**テストコードを作成する
- **網羅的**だが**過剰でない**テストカバレッジを目指す

## 現在のテスト実装状況

### テストカバレッジ（2025年6月20日時点）
- **全体カバレッジ**: 93% (命令カバレッジ)
- **ブランチカバレッジ**: 70%
- **実装済みテストクラス**: 125テスト

#### パッケージ別カバレッジ
- **web.controller**: 100% (完全実装)
- **web.bean**: 100% (完全実装)  
- **web.exception**: 98% (ほぼ完全実装)
- **common.repository**: 95% (高カバレッジ達成)
- **common.service**: 93% (高カバレッジ達成)
- **common.entity**: 73% (改善余地あり)

### 実装済みテストの特徴
- **Mockito-Kotlin**を使用したモック化（オーバーロード問題解決済み）
- **TestRestTemplate**を使用した統合テスト
- **UUID**による一意テストデータ生成でデータ競合回避
- **@DirtiesContext**によるテスト間の独立性確保
- **TestContainers**によるPostgreSQL実環境テスト

### 修正済み問題
1. **Mockito-Kotlin any()メソッドのオーバーロード解決エラー修正**
2. **AuthorControllerIntegrationTestのTestRestTemplate移行**
3. **テストデータの一意性確保**
4. **全125テストの正常実行確認**

## 継続的改善
- **テスト結果**の定期的な分析
- **テスト実行時間**の最適化
- **フレイキーテスト**の早期発見と修正
- **テスト戦略**の定期的な見直し
- **エンティティ層のカバレッジ向上**（現在73%→目標90%以上）