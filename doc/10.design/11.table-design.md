# テーブル設計

本プロジェクトは書籍・著者管理システムとして、著者、書籍、出版の3つのテーブルで構成されています。
書籍と著者は多対多の関係にあり、出版テーブルが中間テーブルとして機能します。

## 1. 著者テーブル (authors)

### テーブル概要
著者の基本情報を管理するマスターテーブルです。

### カラム定義
| カラム名 | データ型 | 制約 | デフォルト値 | 説明 |
|----------|----------|------|--------------|------|
| name | VARCHAR(255) | PRIMARY KEY | - | 著者名（主キー） |
| birth_date | DATE | NOT NULL | - | 生年月日 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | レコード作成日時 |
| created_by | VARCHAR(255) | NOT NULL | 'system' | レコード作成者 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | レコード更新日時 |
| updated_by | VARCHAR(255) | NOT NULL | 'system' | レコード更新者 |

### 制約
- **主キー**: `name`
- **チェック制約**: `chk_birth_date_past` - 生年月日は現在の日付より過去であること
- **トリガー**: `update_authors_updated_at` - 更新時にupdated_atを自動更新

### ビジネスルール
- 著者名は重複不可（主キー制約）
- 生年月日は未来日不可
- 複数の書籍を執筆可能（1対多の関係）

## 2. 書籍テーブル (books)

### テーブル概要
書籍の基本情報と出版状況を管理するマスターテーブルです。

### カラム定義
| カラム名 | データ型 | 制約 | デフォルト値 | 説明 |
|----------|----------|------|--------------|------|
| title | VARCHAR(500) | PRIMARY KEY | - | 書籍タイトル（主キー） |
| price | DECIMAL(10,2) | NOT NULL | - | 価格（小数点以下2桁まで） |
| publication_status | VARCHAR(20) | NOT NULL | 'UNPUBLISHED' | 出版状況 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | レコード作成日時 |
| created_by | VARCHAR(255) | NOT NULL | 'system' | レコード作成者 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | レコード更新日時 |
| updated_by | VARCHAR(255) | NOT NULL | 'system' | レコード更新者 |

### 制約
- **主キー**: `title`
- **チェック制約**: 
  - `chk_price_non_negative` - 価格は0以上であること
  - `chk_publication_status` - 出版状況は'UNPUBLISHED'または'PUBLISHED'のみ
- **トリガー**: 
  - `update_books_updated_at` - 更新時にupdated_atを自動更新
  - `prevent_book_unpublish` - 出版済み書籍の未出版への変更を防ぐ

### ビジネスルール
- 書籍タイトルは重複不可（主キー制約）
- 価格は負の値不可
- 出版状況は以下の2値のみ：
  - `UNPUBLISHED`: 未出版
  - `PUBLISHED`: 出版済み
- **重要**: 出版済み書籍は未出版状態に戻すことができない（ワンウェイ制約）
- 必ず最低1人の著者が必要（出版テーブルの制約により保証）

## 3. 出版テーブル (publications)

### テーブル概要
書籍と著者の多対多関係を管理する中間テーブル（ジャンクションテーブル）です。

### カラム定義
| カラム名 | データ型 | 制約 | デフォルト値 | 説明 |
|----------|----------|------|--------------|------|
| book_title | VARCHAR(500) | NOT NULL | - | 書籍タイトル（外部キー） |
| author_name | VARCHAR(255) | NOT NULL | - | 著者名（外部キー） |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | レコード作成日時 |
| created_by | VARCHAR(255) | NOT NULL | 'system' | レコード作成者 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | レコード更新日時 |
| updated_by | VARCHAR(255) | NOT NULL | 'system' | レコード更新者 |

### 制約
- **複合主キー**: `(book_title, author_name)`
- **外部キー制約**:
  - `fk_publications_book`: `book_title` → `books(title)` (CASCADE)
  - `fk_publications_author`: `author_name` → `authors(name)` (CASCADE)
- **トリガー**: 
  - `update_publications_updated_at` - 更新時にupdated_atを自動更新
  - `ensure_book_author_exists` - 書籍の最後の著者削除を防ぐ

### ビジネスルール
- 同一書籍に同一著者の重複登録不可（複合主キー制約）
- 書籍または著者が削除された場合、関連する出版レコードも自動削除（CASCADE）
- **重要**: 書籍には必ず最低1人の著者が必要（最後の著者は削除不可）

## 4. テーブル間の関係

### ER図概要
```
Authors (1) ←→ (*) Publications (*) ←→ (1) Books
```

### 関係の詳細
- **Authors ←→ Publications**: 1対多
  - 1人の著者は複数の書籍を執筆可能
  - 1つの出版レコードは1人の著者にのみ関連
  
- **Books ←→ Publications**: 1対多
  - 1冊の書籍は複数の著者を持つ可能（共著）
  - 1つの出版レコードは1冊の書籍にのみ関連

- **Authors ←→ Books**: 多対多（Publicationsを通じて）
  - 1人の著者は複数の書籍を執筆可能
  - 1冊の書籍は複数の著者を持つ可能

## 5. データベース機能

### 自動更新機能
- **更新日時の自動更新**: 全テーブルで`updated_at`カラムが更新時に自動更新
- **トリガー関数**: `update_updated_at_column()`を全テーブルで共用

### データ整合性保証
- **参照整合性**: 外部キー制約により関連データの整合性を保証
- **ビジネスルール制約**: チェック制約とトリガーにより業務ルールを強制
- **カスケード削除**: 親レコード削除時の関連レコード自動削除

### パフォーマンス考慮
- **主キー**: 各テーブルで適切な主キーを設定
- **外部キー**: 自動的にインデックスが作成される
- **VARCHAR長**: 用途に応じて適切な長さを設定

## 6. 注意事項とベストプラクティス

### データ操作時の注意点
1. **書籍の出版状況変更**: `PUBLISHED` → `UNPUBLISHED`への変更は不可
2. **著者の削除**: 書籍に関連付けられた著者の削除時は注意（最後の著者は削除不可）
3. **価格設定**: 負の値は設定不可
4. **生年月日**: 未来日は設定不可

### 推奨される操作順序
1. **新規書籍登録**:
   1. 著者を先に登録（存在しない場合）
   2. 書籍を登録
   3. 出版レコードで著者と書籍を関連付け

2. **データ削除**:
   1. 出版レコードを先に削除
   2. 書籍または著者を削除（必要に応じて）

### 運用上の考慮事項
- **audit情報**: 全テーブルで作成者・更新者・作成日時・更新日時を記録
- **CASCADE設定**: データ削除時の影響範囲を十分理解して操作
- **制約エラー**: ビジネスルール違反時は適切なエラーメッセージが表示される
