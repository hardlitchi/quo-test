name: ãƒ†ã‚¹ãƒˆã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ

on:
  push:
    branches: [ main, claude-prototype ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: quo_test
          POSTGRES_USER: quo_user
          POSTGRES_PASSWORD: quo_pass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: wrapper

    - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      run: ./gradlew flywayMigrate

    - name: jOOQã‚¯ãƒ©ã‚¹ç”Ÿæˆ
      run: ./gradlew generateJooq

    - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: ./gradlew test jacocoTestReport

    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          build/reports/jacoco/test/html/
          build/reports/tests/test/

    - name: GitHub Pagesç”¨ãƒ¬ãƒãƒ¼ãƒˆæº–å‚™
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/claude-prototype'
      run: |
        mkdir -p public
        cp -r build/reports/jacoco/test/html/* public/
        cp -r build/reports/tests/test public/junit-reports
        
        # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¸ä½œæˆ
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Quo Test Reports</title>
            <meta charset="UTF-8">
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; margin: 0 auto; }
                .report-link { display: block; margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 8px; text-decoration: none; color: #333; }
                .report-link:hover { background: #e5e5e5; }
                .report-title { font-size: 18px; font-weight: bold; }
                .report-desc { margin-top: 8px; color: #666; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>Quo Test ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ - ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ</h1>
                <p>ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ã‚¹ãƒˆçµæœã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
                
                <a href="./index.html" class="report-link">
                    <div class="report-title">ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ (JaCoCo)</div>
                    <div class="report-desc">ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ100%é”æˆæ¸ˆã¿ï¼‰</div>
                </a>
                
                <a href="./junit-reports/index.html" class="report-link">
                    <div class="report-title">ğŸ§ª JUnitãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ</div>
                    <div class="report-desc">130+ãƒ†ã‚¹ãƒˆã®è©³ç´°å®Ÿè¡Œçµæœ</div>
                </a>
                
                <div style="margin-top: 40px; padding: 20px; background: #e8f5e8; border-radius: 8px;">
                    <h3>âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ³</h3>
                    <ul>
                        <li>ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: <strong>100%</strong></li>
                        <li>ç·ãƒ†ã‚¹ãƒˆæ•°: <strong>130+</strong></li>
                        <li>å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§100%ã‚«ãƒãƒ¬ãƒƒã‚¸é”æˆ</li>
                        <li>ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å“è³ªã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Œæˆ</li>
                    </ul>
                </div>
                
                <div style="margin-top: 20px; font-size: 14px; color: #666;">
                    æœ€çµ‚æ›´æ–°: <span id="timestamp"></span>
                </div>
            </div>
            
            <script>
                document.getElementById('timestamp').textContent = new Date().toLocaleString('ja-JP');
            </script>
        </body>
        </html>
        EOF

    - name: GitHub Pagesã¸ãƒ‡ãƒ—ãƒ­ã‚¤
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/claude-prototype'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        destination_dir: coverage

  build:
    runs-on: ubuntu-latest
    needs: test-and-coverage
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: wrapper

    - name: Build application
      run: ./gradlew build -x test